on: [pull_request]
name: Test
jobs:
  # Label of the container job
  test:
    strategy:
      matrix:
        go-version: [1.19.x, 1.20.x]
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3.3.0
      - uses: KengoTODA/actions-setup-docker-compose@v1
        with:
          version: '2.15.1'
      - name: Install Go
        uses: actions/setup-go@v4.0.0
        with:
          go-version: ${{ matrix.go-version }}
          check-latest: true
      - name: Cache image
        uses: whoan/docker-build-with-cache-action@v5
        with:
          username: whoan
          password: "${{ secrets.GITHUB_TOKEN }}"
          registry: docker.pkg.github.com
          compose_file: docker-compose.yml
      - name: Init unittest environment
        run: make env/test
      - name: Run unittest
        run: make run/test